<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Cloud Netflix</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);

</script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud Netflix</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#service-discovery-eureka-clients">1. Service Discovery: Eureka Clients</a>
<ul class="sectlevel2">
<li><a href="#netflix-eureka-client-starter">1.1. How to Include Eureka Client</a></li>
<li><a href="#registering-with-eureka">1.2. Registering with Eureka</a></li>
<li><a href="#authenticating-with-the-eureka-server">1.3. Authenticating with the Eureka Server</a></li>
<li><a href="#status-page-and-health-indicator">1.4. Status Page and Health Indicator</a></li>
<li><a href="#registering-a-secure-application">1.5. Registering a Secure Application</a></li>
<li><a href="#eurekas-health-checks">1.6. Eureka&#8217;s Health Checks</a></li>
<li><a href="#eureka-metadata-for-instances-and-clients">1.7. Eureka Metadata for Instances and Clients</a>
<ul class="sectlevel3">
<li><a href="#using-eureka-on-cloud-foundry">1.7.1. Using Eureka on Cloud Foundry</a></li>
<li><a href="#using-eureka-on-aws">1.7.2. Using Eureka on AWS</a></li>
<li><a href="#changing-the-eureka-instance-id">1.7.3. Changing the Eureka Instance ID</a></li>
</ul>
</li>
<li><a href="#using-the-eurekaclient">1.8. Using the EurekaClient</a>
<ul class="sectlevel3">
<li><a href="#eurekaclient-without-jersey">1.8.1. EurekaClient without Jersey</a></li>
</ul>
</li>
<li><a href="#alternatives-to-the-native-netflix-eurekaclient">1.9. Alternatives to the Native Netflix EurekaClient</a></li>
<li><a href="#why-is-it-so-slow-to-register-a-service">1.10. Why Is It so Slow to Register a Service?</a></li>
<li><a href="#zones">1.11. Zones</a></li>
<li><a href="#refreshing-eureka-clients">1.12. Refreshing Eureka Clients</a></li>
<li><a href="#using-eureka-with-spring-cloud-loadbalancer">1.13. Using Eureka with Spring Cloud LoadBalancer</a></li>
</ul>
</li>
<li><a href="#spring-cloud-eureka-server">2. Service Discovery: Eureka Server</a>
<ul class="sectlevel2">
<li><a href="#netflix-eureka-server-starter">2.1. How to Include Eureka Server</a></li>
<li><a href="#spring-cloud-running-eureka-server">2.2. How to Run a Eureka Server</a></li>
<li><a href="#spring-cloud-eureka-server-zones-and-regions">2.3. High Availability, Zones and Regions</a></li>
<li><a href="#spring-cloud-eureka-server-standalone-mode">2.4. Standalone Mode</a></li>
<li><a href="#spring-cloud-eureka-server-peer-awareness">2.5. Peer Awareness</a></li>
<li><a href="#spring-cloud-eureka-server-prefer-ip-address">2.6. When to Prefer IP Address</a></li>
<li><a href="#securing-the-eureka-server">2.7. Securing The Eureka Server</a></li>
<li><a href="#jdk-11-support">2.8. JDK 11 Support</a></li>
</ul>
</li>
<li><a href="#configuration-properties">3. Configuration properties</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>3.0.3</strong></p>
</div>
<div class="paragraph">
<p>This project provides Netflix OSS integrations for Spring Boot apps through autoconfiguration
and binding to the Spring Environment and other Spring programming model idioms. With a few
simple annotations you can quickly enable and configure the common patterns inside your
application and build large distributed systems with battle-tested Netflix components. The
patterns provided include Service Discovery (Eureka).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-discovery-eureka-clients"><a class="anchor" href="#service-discovery-eureka-clients"></a><a class="link" href="#service-discovery-eureka-clients">1. Service Discovery: Eureka Clients</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Service Discovery is one of the key tenets of a microservice-based architecture.
Trying to hand-configure each client or some form of convention can be difficult to do and can be brittle.
Eureka is the Netflix Service Discovery Server and Client.
The server can be configured and deployed to be highly available, with each server replicating state about the registered services to the others.</p>
</div>
<div class="sect2">
<h3 id="netflix-eureka-client-starter"><a class="anchor" href="#netflix-eureka-client-starter"></a><a class="link" href="#netflix-eureka-client-starter">1.1. How to Include Eureka Client</a></h3>
<div class="paragraph">
<p>To include the Eureka Client in your project, use the starter with a group ID of <code>org.springframework.cloud</code> and an artifact ID of <code>spring-cloud-starter-netflix-eureka-client</code>.
See the <a href="https://projects.spring.io/spring-cloud/">Spring Cloud Project page</a> for details on setting up your build system with the current Spring Cloud Release Train.</p>
</div>
</div>
<div class="sect2">
<h3 id="registering-with-eureka"><a class="anchor" href="#registering-with-eureka"></a><a class="link" href="#registering-with-eureka">1.2. Registering with Eureka</a></h3>
<div class="paragraph">
<p>When a client registers with Eureka, it provides meta-data about itself&#8201;&#8212;&#8201;such as host, port, health indicator URL, home page, and other details.
Eureka receives heartbeat messages from each instance belonging to a service.
If the heartbeat fails over a configurable timetable, the instance is normally removed from the registry.</p>
</div>
<div class="paragraph">
<p>The following example shows a minimal Eureka client application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@RestController
public class Application {

    @RequestMapping("/")
    public String home() {
        return "Hello world";
    }

    public static void main(String[] args) {
        new SpringApplicationBuilder(Application.class).web(true).run(args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the preceding example shows a normal <a href="https://projects.spring.io/spring-boot/">Spring Boot</a> application.
By having <code>spring-cloud-starter-netflix-eureka-client</code> on the classpath, your application automatically registers with the Eureka Server. Configuration is required to locate the Eureka server, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/</pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, <code>defaultZone</code> is a magic string fallback value that provides the service URL for any client that does not express a preference (in other words, it is a useful default).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>defaultZone</code> property is case sensitive and requires camel case because the <code>serviceUrl</code> property is a <code>Map&lt;String, String&gt;</code>. Therefore, the <code>defaultZone</code> property does not follow the normal Spring Boot snake-case convention of <code>default-zone</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default application name (that is, the service ID), virtual host, and non-secure port (taken from the <code>Environment</code>) are <code>${spring.application.name}</code>, <code>${spring.application.name}</code> and <code>${server.port}</code>, respectively.</p>
</div>
<div class="paragraph">
<p>Having <code>spring-cloud-starter-netflix-eureka-client</code> on the classpath makes the app into both a Eureka &#8220;instance&#8221; (that is, it registers itself) and a &#8220;client&#8221; (it can query the registry to locate other services).
The instance behaviour is driven by <code>eureka.instance.*</code> configuration keys, but the defaults are fine if you ensure that your application has a value for <code>spring.application.name</code> (this is the default for the Eureka service ID or VIP).</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/spring-cloud/spring-cloud-netflix/tree/main/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaInstanceConfigBean.java">EurekaInstanceConfigBean</a> and <a href="https://github.com/spring-cloud/spring-cloud-netflix/tree/main/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaClientConfigBean.java">EurekaClientConfigBean</a> for more details on the configurable options.</p>
</div>
<div class="paragraph">
<p>To disable the Eureka Discovery Client, you can set <code>eureka.client.enabled</code> to <code>false</code>. Eureka Discovery Client will also be disabled when <code>spring.cloud.discovery.enabled</code> is set to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="authenticating-with-the-eureka-server"><a class="anchor" href="#authenticating-with-the-eureka-server"></a><a class="link" href="#authenticating-with-the-eureka-server">1.3. Authenticating with the Eureka Server</a></h3>
<div class="paragraph">
<p>HTTP basic authentication is automatically added to your eureka client if one of the <code>eureka.client.serviceUrl.defaultZone</code> URLs has credentials embedded in it (curl style, as follows: <code><a href="https://user:password@localhost:8761/eureka" class="bare">user:<span class="__cf_email__" data-cfemail="ee9e8f9d9d99819c8aae82818d8f8286819d9a">[email&#160;protected]</span>:8761/eureka</a></code>).
For more complex needs, you can create a <code>@Bean</code> of type <code>DiscoveryClientOptionalArgs</code> and inject <code>ClientFilter</code> instances into it, all of which is applied to the calls from the client to the server.</p>
</div>
<div class="paragraph">
<p>When Eureka server requires client side certificate for authentication, the client side certificate and trust store can be configured via properties, as shown in following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">eureka:
  client:
    tls:
      enabled: true
      key-store: &lt;path-of-key-store&gt;
      key-store-type: PKCS12
      key-store-password: &lt;key-store-password&gt;
      key-password: &lt;key-password&gt;
      trust-store: &lt;path-of-trust-store&gt;
      trust-store-type: PKCS12
      trust-store-password: &lt;trust-store-password&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>eureka.client.tls.enabled</code> needs to be true to enable Eureka client side TLS. When <code>eureka.client.tls.trust-store</code> is omitted, a JVM default trust store is used. The default value for <code>eureka.client.tls.key-store-type</code> and <code>eureka.client.tls.trust-store-type</code> is PKCS12. When password properties are omitted, empty password is assumed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because of a limitation in Eureka, it is not possible to support per-server basic auth credentials, so only the first set that are found is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to customize the RestTemplate used by the Eureka HTTP Client you may want to create a bean of <code>EurekaClientHttpRequestFactorySupplier</code> and provide your own logic for generating a <code>ClientHttpRequestFactory</code> instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="status-page-and-health-indicator"><a class="anchor" href="#status-page-and-health-indicator"></a><a class="link" href="#status-page-and-health-indicator">1.4. Status Page and Health Indicator</a></h3>
<div class="paragraph">
<p>The status page and health indicators for a Eureka instance default to <code>/info</code> and <code>/health</code> respectively, which are the default locations of useful endpoints in a Spring Boot Actuator application.
You need to change these, even for an Actuator application if you use a non-default context path or servlet path (such as <code>server.servletPath=/custom</code>). The following example shows the default values for the two settings:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  instance:
    statusPageUrlPath: ${server.servletPath}/info
    healthCheckUrlPath: ${server.servletPath}/health</pre>
</div>
</div>
<div class="paragraph">
<p>These links show up in the metadata that is consumed by clients and are used in some scenarios to decide whether to send requests to your application, so it is helpful if they are accurate.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Dalston it was also required to set the status and health check URLs when changing
that management context path. This requirement was removed beginning in Edgware.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="registering-a-secure-application"><a class="anchor" href="#registering-a-secure-application"></a><a class="link" href="#registering-a-secure-application">1.5. Registering a Secure Application</a></h3>
<div class="paragraph">
<p>If your app wants to be contacted over HTTPS, you can set two flags in the <code>EurekaInstanceConfigBean</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>eureka.instance.[nonSecurePortEnabled]=[false]</code></p>
</li>
<li>
<p><code>eureka.instance.[securePortEnabled]=[true]</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Doing so makes Eureka publish instance information that shows an explicit preference for secure communication.
The Spring Cloud <code>DiscoveryClient</code> always returns a URI starting with <code>https</code> for a service configured this way.
Similarly, when a service is configured this way, the Eureka (native) instance information has a secure health check URL.</p>
</div>
<div class="paragraph">
<p>Because of the way Eureka works internally, it still publishes a non-secure URL for the status and home pages unless you also override those explicitly.
You can use placeholders to configure the eureka instance URLs, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  instance:
    statusPageUrl: https://${eureka.hostname}/info
    healthCheckUrl: https://${eureka.hostname}/health
    homePageUrl: https://${eureka.hostname}/</pre>
</div>
</div>
<div class="paragraph">
<p>(Note that <code>${eureka.hostname}</code> is a native placeholder only available
in later versions of Eureka. You could achieve the same thing with
Spring placeholders as well&#8201;&#8212;&#8201;for example, by using <code>${eureka.instance.hostName}</code>.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your application runs behind a proxy, and the SSL termination is in the proxy (for example, if you run in Cloud Foundry or other platforms as a service), then you need to ensure that the proxy &#8220;forwarded&#8221; headers are intercepted and handled by the application.
If the Tomcat container embedded in a Spring Boot application has explicit configuration for the 'X-Forwarded-\*` headers, this happens automatically.
The links rendered by your app to itself being wrong (the wrong host, port, or protocol) is a sign that you got this configuration wrong.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="eurekas-health-checks"><a class="anchor" href="#eurekas-health-checks"></a><a class="link" href="#eurekas-health-checks">1.6. Eureka&#8217;s Health Checks</a></h3>
<div class="paragraph">
<p>By default, Eureka uses the client heartbeat to determine if a client is up.
Unless specified otherwise, the Discovery Client does not propagate the current health check status of the application, per the Spring Boot Actuator.
Consequently, after successful registration, Eureka always announces that the application is in 'UP' state. This behavior can be altered by enabling Eureka health checks, which results in propagating application status to Eureka.
As a consequence, every other application does not send traffic to applications in states other then 'UP'.
The following example shows how to enable health checks for the client:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  client:
    healthcheck:
      enabled: true</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>eureka.client.healthcheck.enabled=true</code> should only be set in <code>application.yml</code>. Setting the value in <code>bootstrap.yml</code> causes undesirable side effects, such as registering in Eureka with an <code>UNKNOWN</code> status.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you require more control over the health checks, consider implementing your own <code>com.netflix.appinfo.HealthCheckHandler</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="eureka-metadata-for-instances-and-clients"><a class="anchor" href="#eureka-metadata-for-instances-and-clients"></a><a class="link" href="#eureka-metadata-for-instances-and-clients">1.7. Eureka Metadata for Instances and Clients</a></h3>
<div class="paragraph">
<p>It is worth spending a bit of time understanding how the Eureka metadata works, so you can use it in a way that makes sense in your platform.
There is standard metadata for information such as hostname, IP address, port numbers, the status page, and health check.
These are published in the service registry and used by clients to contact the services in a straightforward way.
Additional metadata can be added to the instance registration in the <code>eureka.instance.metadataMap</code>, and this metadata is accessible in the remote clients.
In general, additional metadata does not change the behavior of the client, unless the client is made aware of the meaning of the metadata.
There are a couple of special cases, described later in this document, where Spring Cloud already assigns meaning to the metadata map.</p>
</div>
<div class="sect3">
<h4 id="using-eureka-on-cloud-foundry"><a class="anchor" href="#using-eureka-on-cloud-foundry"></a><a class="link" href="#using-eureka-on-cloud-foundry">1.7.1. Using Eureka on Cloud Foundry</a></h4>
<div class="paragraph">
<p>Cloud Foundry has a global router so that all instances of the same app have the same hostname (other PaaS solutions with a similar architecture have the same arrangement).
This is not necessarily a barrier to using Eureka.
However, if you use the router (recommended or even mandatory, depending on the way your platform was set up), you need to explicitly set the hostname and port numbers (secure or non-secure) so that they use the router.
You might also want to use instance metadata so that you can distinguish between the instances on the client (for example, in a custom load balancer).
By default, the <code>eureka.instance.instanceId</code> is <code>vcap.application.instance_id</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  instance:
    hostname: ${vcap.application.uris[0]}
    nonSecurePort: 80</pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the way the security rules are set up in your Cloud Foundry instance, you might be able to register and use the IP address of the host VM for direct service-to-service calls.
This feature is not yet available on Pivotal Web Services (<a href="https://run.pivotal.io">PWS</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="using-eureka-on-aws"><a class="anchor" href="#using-eureka-on-aws"></a><a class="link" href="#using-eureka-on-aws">1.7.2. Using Eureka on AWS</a></h4>
<div class="paragraph">
<p>If the application is planned to be deployed to an AWS cloud, the Eureka instance must be configured to be AWS-aware. You can do so by customizing the <a href="https://github.com/spring-cloud/spring-cloud-netflix/tree/main/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaInstanceConfigBean.java">EurekaInstanceConfigBean</a> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
@Profile("!default")
public EurekaInstanceConfigBean eurekaInstanceConfig(InetUtils inetUtils) {
  EurekaInstanceConfigBean bean = new EurekaInstanceConfigBean(inetUtils);
  AmazonInfo info = AmazonInfo.Builder.newBuilder().autoBuild("eureka");
  bean.setDataCenterInfo(info);
  return bean;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="changing-the-eureka-instance-id"><a class="anchor" href="#changing-the-eureka-instance-id"></a><a class="link" href="#changing-the-eureka-instance-id">1.7.3. Changing the Eureka Instance ID</a></h4>
<div class="paragraph">
<p>A vanilla Netflix Eureka instance is registered with an ID that is equal to its host name (that is, there is only one service per host).
Spring Cloud Eureka provides a sensible default, which is defined as follows:</p>
</div>
<div class="paragraph">
<p><code>${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id:${server.port}}</code></p>
</div>
<div class="paragraph">
<p>An example is <code>myhost:myappname:8080</code>.</p>
</div>
<div class="paragraph">
<p>By using Spring Cloud, you can override this value by providing a unique identifier in <code>eureka.instance.instanceId</code>, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>eureka:
  instance:
    instanceId: ${spring.application.name}:${vcap.application.instance_id:${spring.application.instance_id:${random.value}}}</pre>
</div>
</div>
<div class="paragraph">
<p>With the metadata shown in the preceding example and multiple service instances deployed on localhost, the random value is inserted there to make the instance unique.
In Cloud Foundry, the <code>vcap.application.instance_id</code> is populated automatically in a Spring Boot application, so the random value is not needed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-the-eurekaclient"><a class="anchor" href="#using-the-eurekaclient"></a><a class="link" href="#using-the-eurekaclient">1.8. Using the EurekaClient</a></h3>
<div class="paragraph">
<p>Once you have an application that is a discovery client, you can use it to discover service instances from the <a href="#spring-cloud-eureka-server">Eureka Server</a>.
One way to do so is to use the native <code>com.netflix.discovery.EurekaClient</code> (as opposed to the Spring Cloud <code>DiscoveryClient</code>), as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Autowired
private EurekaClient discoveryClient;

public String serviceUrl() {
    InstanceInfo instance = discoveryClient.getNextServerFromEureka("STORES", false);
    return instance.getHomePageUrl();
}</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use the <code>EurekaClient</code> in a <code>@PostConstruct</code> method or in a <code>@Scheduled</code> method (or anywhere where the <code>ApplicationContext</code> might not be started yet).
It is initialized in a <code>SmartLifecycle</code> (with <code>phase=0</code>), so the earliest you can rely on it being available is in another <code>SmartLifecycle</code> with a higher phase.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="eurekaclient-without-jersey"><a class="anchor" href="#eurekaclient-without-jersey"></a><a class="link" href="#eurekaclient-without-jersey">1.8.1. EurekaClient without Jersey</a></h4>
<div class="paragraph">
<p>By default, EurekaClient uses Spring&#8217;s <code>RestTemplate</code> for HTTP communication.
If you wish to use Jersey instead, you need to add the Jersey dependencies to your classpath.
The following example shows the dependencies you need to add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt;
    &lt;artifactId&gt;jersey-client&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.sun.jersey&lt;/groupId&gt;
    &lt;artifactId&gt;jersey-core&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.sun.jersey.contribs&lt;/groupId&gt;
    &lt;artifactId&gt;jersey-apache-client4&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="alternatives-to-the-native-netflix-eurekaclient"><a class="anchor" href="#alternatives-to-the-native-netflix-eurekaclient"></a><a class="link" href="#alternatives-to-the-native-netflix-eurekaclient">1.9. Alternatives to the Native Netflix EurekaClient</a></h3>
<div class="paragraph">
<p>You need not use the raw Netflix <code>EurekaClient</code>.
Also, it is usually more convenient to use it behind a wrapper of some sort.
Spring Cloud has support for <a href="#spring-cloud-feign">Feign</a> (a REST client builder) and <a href="#spring-cloud-ribbon">Spring <code>RestTemplate</code></a> through the logical Eureka service identifiers (VIPs) instead of physical URLs.</p>
</div>
<div class="paragraph">
<p>You can also use the <code>org.springframework.cloud.client.discovery.DiscoveryClient</code>, which provides a simple API (not specific to Netflix) for discovery clients, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Autowired
private DiscoveryClient discoveryClient;

public String serviceUrl() {
    List&lt;ServiceInstance&gt; list = discoveryClient.getInstances("STORES");
    if (list != null &amp;&amp; list.size() &gt; 0 ) {
        return list.get(0).getUri();
    }
    return null;
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="why-is-it-so-slow-to-register-a-service"><a class="anchor" href="#why-is-it-so-slow-to-register-a-service"></a><a class="link" href="#why-is-it-so-slow-to-register-a-service">1.10. Why Is It so Slow to Register a Service?</a></h3>
<div class="paragraph">
<p>Being an instance also involves a periodic heartbeat to the registry
(through the client&#8217;s <code>serviceUrl</code>) with a default duration of 30 seconds.
A service is not available for discovery by clients until the instance, the server, and the client all have the same metadata in their local
cache (so it could take 3 heartbeats).
You can change the period by setting <code>eureka.instance.leaseRenewalIntervalInSeconds</code>.
Setting it to a value of less than 30 speeds up the process of getting clients connected to other services.
In production, it is probably better to stick with the default, because of internal computations in the server that make assumptions about the lease renewal period.</p>
</div>
</div>
<div class="sect2">
<h3 id="zones"><a class="anchor" href="#zones"></a><a class="link" href="#zones">1.11. Zones</a></h3>
<div class="paragraph">
<p>If you have deployed Eureka clients to multiple zones, you may prefer that those clients use services within the same zone before trying services in another zone.
To set that up, you need to configure your Eureka clients correctly.</p>
</div>
<div class="paragraph">
<p>First, you need to make sure you have Eureka servers deployed to each zone and that
they are peers of each other.
See the section on <a href="#spring-cloud-eureka-server-zones-and-regions">zones and regions</a>
for more information.</p>
</div>
<div class="paragraph">
<p>Next, you need to tell Eureka which zone your service is in.
You can do so by using the <code>metadataMap</code> property.
For example, if <code>service 1</code> is deployed to both <code>zone 1</code> and <code>zone 2</code>, you need to set the following Eureka properties in <code>service 1</code>:</p>
</div>
<div class="paragraph">
<p><strong>Service 1 in Zone 1</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>eureka.instance.metadataMap.zone = zone1
eureka.client.preferSameZoneEureka = true</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Service 1 in Zone 2</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>eureka.instance.metadataMap.zone = zone2
eureka.client.preferSameZoneEureka = true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="refreshing-eureka-clients"><a class="anchor" href="#refreshing-eureka-clients"></a><a class="link" href="#refreshing-eureka-clients">1.12. Refreshing Eureka Clients</a></h3>
<div class="paragraph">
<p>By default, the <code>EurekaClient</code> bean is refreshable, meaning the Eureka client properties can be changed and refreshed.
When a refresh occurs clients will be unregistered from the Eureka server and there might be a brief moment of time
where all instance of a given service are not available. One way to eliminate this from happening is to disable
the ability to refresh Eureka clients. To do this set <code>eureka.client.refresh.enable=false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-eureka-with-spring-cloud-loadbalancer"><a class="anchor" href="#using-eureka-with-spring-cloud-loadbalancer"></a><a class="link" href="#using-eureka-with-spring-cloud-loadbalancer">1.13. Using Eureka with Spring Cloud LoadBalancer</a></h3>
<div class="paragraph">
<p>We offer support for the Spring Cloud LoadBalancer <code>ZonePreferenceServiceInstanceListSupplier</code>.
The <code>zone</code> value from the Eureka instance metadata (<code>eureka.instance.metadataMap.zone</code>) is used for setting the
value of <code>spring-clod-loadbalancer-zone</code> property that is used to filter service instances by zone.</p>
</div>
<div class="paragraph">
<p>If that is missing and if the <code>spring.cloud.loadbalancer.eureka.approximateZoneFromHostname</code> flag is set to <code>true</code>,
it can use the domain name from the server hostname as a proxy for the zone.</p>
</div>
<div class="paragraph">
<p>If there is no other source of zone data, then a guess is made, based on the client configuration (as opposed to the instance configuration).
We take <code>eureka.client.availabilityZones</code>, which is a map from region name to a list of zones, and pull out the first zone for the instance&#8217;s own region (that is, the <code>eureka.client.region</code>, which defaults to "us-east-1", for compatibility with native Netflix).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-eureka-server"><a class="anchor" href="#spring-cloud-eureka-server"></a><a class="link" href="#spring-cloud-eureka-server">2. Service Discovery: Eureka Server</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to set up a Eureka server.</p>
</div>
<div class="sect2">
<h3 id="netflix-eureka-server-starter"><a class="anchor" href="#netflix-eureka-server-starter"></a><a class="link" href="#netflix-eureka-server-starter">2.1. How to Include Eureka Server</a></h3>
<div class="paragraph">
<p>To include Eureka Server in your project, use the starter with a group ID of <code>org.springframework.cloud</code> and an artifact ID of <code>spring-cloud-starter-netflix-eureka-server</code>.
See the <a href="https://projects.spring.io/spring-cloud/">Spring Cloud Project page</a> for details on setting up your build system with the current Spring Cloud Release Train.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your project already uses Thymeleaf as its template engine, the Freemarker templates of the Eureka server may not be loaded correctly. In this case it is necessary to configure the template loader manually:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre>spring:
  freemarker:
    template-loader-path: classpath:/templates/
    prefer-file-system-access: false</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-running-eureka-server"><a class="anchor" href="#spring-cloud-running-eureka-server"></a><a class="link" href="#spring-cloud-running-eureka-server">2.2. How to Run a Eureka Server</a></h3>
<div class="paragraph">
<p>The following example shows a minimal Eureka server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableEurekaServer
public class Application {

    public static void main(String[] args) {
        new SpringApplicationBuilder(Application.class).web(true).run(args);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server has a home page with a UI and HTTP API endpoints for the normal Eureka functionality under <code>/eureka/*</code>.</p>
</div>
<div class="paragraph">
<p>The following links have some Eureka background reading: <a href="https://github.com/cfregly/fluxcapacitor/wiki/NetflixOSS-FAQ#eureka-service-discovery-load-balancer">flux capacitor</a> and <a href="https://groups.google.com/forum/?fromgroups#!topic/eureka_netflix/g3p2r7gHnN0">google group discussion</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to Gradle&#8217;s dependency resolution rules and the lack of a parent bom feature, depending on <code>spring-cloud-starter-netflix-eureka-server</code> can cause failures on application startup.
To remedy this issue, add the Spring Boot Gradle plugin and import the Spring cloud starter parent bom as follows:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">buildscript {
  dependencies {
    classpath("org.springframework.boot:spring-boot-gradle-plugin:{spring-boot-docs-version}")
  }
}

apply plugin: "spring-boot"

dependencyManagement {
  imports {
    mavenBom "org.springframework.cloud:spring-cloud-dependencies:{spring-cloud-version}"
  }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-eureka-server-zones-and-regions"><a class="anchor" href="#spring-cloud-eureka-server-zones-and-regions"></a><a class="link" href="#spring-cloud-eureka-server-zones-and-regions">2.3. High Availability, Zones and Regions</a></h3>
<div class="paragraph">
<p>The Eureka server does not have a back end store, but the service instances in the registry all have to send heartbeats to keep their registrations up to date (so this can be done in memory).
Clients also have an in-memory cache of Eureka registrations (so they do not have to go to the registry for every request to a service).</p>
</div>
<div class="paragraph">
<p>By default, every Eureka server is also a Eureka client and requires (at least one) service URL to locate a peer.
If you do not provide it, the service runs and works, but it fills your logs with a lot of noise about not being able to register with the peer.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-eureka-server-standalone-mode"><a class="anchor" href="#spring-cloud-eureka-server-standalone-mode"></a><a class="link" href="#spring-cloud-eureka-server-standalone-mode">2.4. Standalone Mode</a></h3>
<div class="paragraph">
<p>The combination of the two caches (client and server) and the heartbeats make a standalone Eureka server fairly resilient to failure, as long as there is some sort of monitor or elastic runtime (such as Cloud Foundry) keeping it alive.
In standalone mode, you might prefer to switch off the client side behavior so that it does not keep trying and failing to reach its peers.
The following example shows how to switch off the client-side behavior:</p>
</div>
<div class="listingblock">
<div class="title">application.yml (Standalone Eureka Server)</div>
<div class="content">
<pre>server:
  port: 8761

eureka:
  instance:
    hostname: localhost
  client:
    registerWithEureka: false
    fetchRegistry: false
    serviceUrl:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the <code>serviceUrl</code> is pointing to the same host as the local instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-eureka-server-peer-awareness"><a class="anchor" href="#spring-cloud-eureka-server-peer-awareness"></a><a class="link" href="#spring-cloud-eureka-server-peer-awareness">2.5. Peer Awareness</a></h3>
<div class="paragraph">
<p>Eureka can be made even more resilient and available by running multiple instances and asking them to register with each other.
In fact, this is the default behavior, so all you need to do to make it work is add a valid <code>serviceUrl</code> to a peer, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="title">application.yml (Two Peer Aware Eureka Servers)</div>
<div class="content">
<pre>---
spring:
  profiles: peer1
eureka:
  instance:
    hostname: peer1
  client:
    serviceUrl:
      defaultZone: https://peer2/eureka/

---
spring:
  profiles: peer2
eureka:
  instance:
    hostname: peer2
  client:
    serviceUrl:
      defaultZone: https://peer1/eureka/</pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, we have a YAML file that can be used to run the same server on two hosts (<code>peer1</code> and <code>peer2</code>) by running it in different Spring profiles.
You could use this configuration to test the peer awareness on a single host (there is not much value in doing that in production) by manipulating <code>/etc/hosts</code> to resolve the host names.
In fact, the <code>eureka.instance.hostname</code> is not needed if you are running on a machine that knows its own hostname (by default, it is looked up by using <code>java.net.InetAddress</code>).</p>
</div>
<div class="paragraph">
<p>You can add multiple peers to a system, and, as long as they are all connected to each other by at least one edge, they synchronize
the registrations amongst themselves.
If the peers are physically separated (inside a data center or between multiple data centers), then the system can, in principle, survive &#8220;split-brain&#8221; type failures.
You can add multiple peers to a system, and as long as they are all
directly connected to each other, they will synchronize
the registrations amongst themselves.</p>
</div>
<div class="listingblock">
<div class="title">application.yml (Three Peer Aware Eureka Servers)</div>
<div class="content">
<pre>eureka:
  client:
    serviceUrl:
      defaultZone: https://peer1/eureka/,http://peer2/eureka/,http://peer3/eureka/

---
spring:
  profiles: peer1
eureka:
  instance:
    hostname: peer1

---
spring:
  profiles: peer2
eureka:
  instance:
    hostname: peer2

---
spring:
  profiles: peer3
eureka:
  instance:
    hostname: peer3</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-eureka-server-prefer-ip-address"><a class="anchor" href="#spring-cloud-eureka-server-prefer-ip-address"></a><a class="link" href="#spring-cloud-eureka-server-prefer-ip-address">2.6. When to Prefer IP Address</a></h3>
<div class="paragraph">
<p>In some cases, it is preferable for Eureka to advertise the IP addresses of services rather than the hostname.
Set <code>eureka.instance.preferIpAddress</code> to <code>true</code> and, when the application registers with eureka, it uses its IP address rather than its hostname.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the hostname cannot be determined by Java, then the IP address is sent to Eureka.
Only explict way of setting the hostname is by setting <code>eureka.instance.hostname</code> property.
You can set your hostname at the run-time by using an environment variable&#8201;&#8212;&#8201;for example, <code>eureka.instance.hostname=${HOST_NAME}</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="securing-the-eureka-server"><a class="anchor" href="#securing-the-eureka-server"></a><a class="link" href="#securing-the-eureka-server">2.7. Securing The Eureka Server</a></h3>
<div class="paragraph">
<p>You can secure your Eureka server simply by adding Spring Security to your
server&#8217;s classpath via <code>spring-boot-starter-security</code>. By default when Spring Security is on the classpath it will require that
a valid CSRF token be sent with every request to the app. Eureka clients will not generally possess a valid
cross site request forgery (CSRF) token you will need to disable this requirement for the <code>/eureka/**</code> endpoints.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().ignoringAntMatchers("/eureka/**");
        super.configure(http);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on CSRF see the <a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#csrf">Spring Security documentation</a>.</p>
</div>
<div class="paragraph">
<p>A demo Eureka Server can be found in the Spring Cloud Samples <a href="https://github.com/spring-cloud-samples/eureka/tree/Eureka-With-Security">repo</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jdk-11-support"><a class="anchor" href="#jdk-11-support"></a><a class="link" href="#jdk-11-support">2.8. JDK 11 Support</a></h3>
<div class="paragraph">
<p>The JAXB modules which the Eureka server depends upon were removed in JDK 11. If you intend to use JDK 11
when running a Eureka server you must include these dependencies in your POM or Gradle file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.glassfish.jaxb&lt;/groupId&gt;
    &lt;artifactId&gt;jaxb-runtime&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a><a class="link" href="#configuration-properties">3. Configuration properties</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Spring Cloud Netflix related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
<script>if (window.parent == window) {(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-2728886-23', 'auto', {'siteSpeedSampleRate': 100});ga('send', 'pageview');}</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"rayId":"672dddaf1a801964","token":"bffcb8a918ae4755926f76178bfbd26b","version":"2021.7.0","si":10}'></script>
</body>
</html>